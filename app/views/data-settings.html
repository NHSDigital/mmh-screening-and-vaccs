{% extends 'layout.html' %}

{% set pageHeading = "Data settings" %}
{% set pageDescription = "Change and save the dynamic content used in the prototype." %}

{% set mainClasses = "nhsuk-main-wrapper--s" %}

{% block beforeContent %}
  {{ backLink({
    "text": "Back",
    "classes": "nhsuk-u-margin-bottom-0",
    href: "/"
  }) }}
{% endblock %}

{% block content %}
  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-three-quarters">

      <h1>{{ pageHeading }}</h1>

      <p class="nhsuk-lede-text">
        {{ pageDescription }}
      </p>

      <hr>

      <form method="post" action="/frame" novalidate="novalidate">

        {% set personaItems = [] %}
        {% for p in personas %}
          {% set label %}{{ p.id }} {{ p.lastName }}, {{ p.age }}, {{ p.sex }}{% endset %}
          {% if p.proxies | length %}
            {% set proxyWord = "proxy" if p.proxies | length == 1 else "proxies" %}
            {% set label = label + " (" + p.proxies | length + " " + proxyWord + ")" %}
          {% endif %}

          {% set hintHtml %}
            <details class="nhsuk-details nhsuk-u-margin-top-2 nhsuk-u-margin-bottom-0">
              <summary class="nhsuk-details__summary">
                <span class="nhsuk-details__summary-text">View profile</span>
              </summary>
              <div class="nhsuk-details__text">

                <h3 class="nhsuk-heading-xs nhsuk-u-margin-bottom-2">Profile</h3>
                <dl class="nhsuk-summary-list nhsuk-summary-list--no-border nhsuk-u-margin-bottom-4">
                  <div class="nhsuk-summary-list__row">
                    <dt class="nhsuk-summary-list__key">Date of birth</dt>
                    <dd class="nhsuk-summary-list__value">{{ p.dateOfBirth }} (age {{ p.age }})</dd>
                  </div>
                  <div class="nhsuk-summary-list__row">
                    <dt class="nhsuk-summary-list__key">Sex</dt>
                    <dd class="nhsuk-summary-list__value">{{ p.sex | capitalize }}</dd>
                  </div>
                  {% if p.nominatedGpSurgery %}
                    {% set gpLocation = null %}
                    {% for location in locations %}
                      {% if location.id === p.nominatedGpSurgery %}
                        {% set gpLocation = location %}
                      {% endif %}
                    {% endfor %}
                    <div class="nhsuk-summary-list__row">
                      <dt class="nhsuk-summary-list__key">GP surgery</dt>
                      <dd class="nhsuk-summary-list__value">{{ gpLocation.name if gpLocation else p.nominatedGpSurgery }}</dd>
                    </div>
                  {% endif %}
                  {% if p.nominatedPharmacy %}
                    {% set pharmacyLocation = null %}
                    {% for location in locations %}
                      {% if location.id === p.nominatedPharmacy %}
                        {% set pharmacyLocation = location %}
                      {% endif %}
                    {% endfor %}
                    <div class="nhsuk-summary-list__row">
                      <dt class="nhsuk-summary-list__key">Pharmacy</dt>
                      <dd class="nhsuk-summary-list__value">{{ pharmacyLocation.name if pharmacyLocation else p.nominatedPharmacy }}</dd>
                    </div>
                  {% endif %}
                </dl>

                {% if p.conditions %}
                  <h3 class="nhsuk-heading-xs nhsuk-u-margin-bottom-2">Conditions</h3>
                  <dl class="nhsuk-summary-list nhsuk-summary-list--no-border nhsuk-u-margin-bottom-4">
                    {% for key, value in p.conditions %}
                      <div class="nhsuk-summary-list__row">
                        <dt class="nhsuk-summary-list__key">{{ key }}</dt>
                        <dd class="nhsuk-summary-list__value">
                          {% if value === true %}Yes
                          {% elif value === false %}No
                          {% else %}Unknown
                          {% endif %}
                        </dd>
                      </div>
                    {% endfor %}
                  </dl>
                {% endif %}

                {% if p.history %}
                  <h3 class="nhsuk-heading-xs nhsuk-u-margin-bottom-2">History</h3>
                  <dl class="nhsuk-summary-list nhsuk-summary-list--no-border nhsuk-u-margin-bottom-4">
                    {% for key, value in p.history %}
                      <div class="nhsuk-summary-list__row">
                        <dt class="nhsuk-summary-list__key">{{ key }}</dt>
                        <dd class="nhsuk-summary-list__value">
                          {% if value.optedOut %}Opted out
                          {% elif value.lastDate %}{{ value.lastDate }}
                          {% endif %}
                        </dd>
                      </div>
                    {% endfor %}
                  </dl>
                {% endif %}

                {% if p.proxies | length %}
                  {% for proxy in p.proxies %}
                    <h3 class="nhsuk-heading-xs nhsuk-u-margin-bottom-2">Proxy: {{ proxy.id }} {{ proxy.lastName }} (age {{ proxy.age }}, {{ proxy.sex }})</h3>
                    {% if proxy.history %}
                      <dl class="nhsuk-summary-list nhsuk-summary-list--no-border nhsuk-u-margin-bottom-4">
                        {% for key, value in proxy.history %}
                          <div class="nhsuk-summary-list__row">
                            <dt class="nhsuk-summary-list__key">{{ key }}</dt>
                            <dd class="nhsuk-summary-list__value">{{ value.lastDate }}</dd>
                          </div>
                        {% endfor %}
                      </dl>
                    {% endif %}
                  {% endfor %}
                {% endif %}

              </div>
            </details>
          {% endset %}

          {% set personaItems = (personaItems.push({
            "value": p.id,
            "text": label,
            "checked": checked("persona", p.id),
            "hint": {
              "html": hintHtml
            }
          }), personaItems) %}
        {% endfor %}

        {{ radios({
          "idPrefix": "persona",
          "name": "persona",
          "fieldset": {
            "legend": {
              "text": "Persona",
              "classes": "nhsuk-fieldset__legend--m"
            }
          },
          "hint": {
            "text": "Changes which screening and vaccinations are shown"
          },
          "items": personaItems
        }) }}

        <p><a href="/pages/create-persona/name">Create a persona</a></p>

        {{ radios({
          "idPrefix": "web",
          "name": "web",
          "fieldset": {
            "legend": {
              "text": "Web or native?",
              "classes": "nhsuk-fieldset__legend--m"
            }
          },
          "hint": {
            "text": "This displays the web or native header and footer"
          },
          "items": [
            {
              "value": "yes",
              "text": "Web",
              checked: checked("web", "yes")
            },
            {
              "value": "no",
              "text": "Native",
              checked: checked("web", "no")
            }
          ]
        }) }}

        <hr>

        {{ radios({
          "idPrefix": "accountType",
          "name": "accountType",
          "fieldset": {
            "legend": {
              "text": "Account type",
              "classes": "nhsuk-fieldset__legend--m"
            }
          },
          "hint": {
            "text": "This changes the page URLs in the main nav"
          },
          "items": [
            {
              "value": "p9",
              "text": "P9",
              checked: checked("accountType", "p9")
            },
            {
              "value": "p5",
              "text": "P5",
              checked: checked("accountType", "p5")
            },
            {
              "value": "linked-profiles",
              "text": "Linked profile",
              checked: checked("accountType", "linked-profiles")
            }
          ]
        }) }}

        <hr>

        <h2 class="nhsuk-heading-m nhsuk-u-margin-bottom-3">Errors</h2>

        {{ radios({
          "idPrefix": "loginError",
          "name": "loginError",
          "fieldset": {
            "legend": {
              "text": "Login error",
              "classes": "nhsuk-label"
            }
          },
          "items": [
            {
              "value": "yes",
              "text": "Yes",
              checked: checked("loginError", "yes")
            },
            {
              "value": "no",
              "text": "No",
              checked: checked("loginError", "no")
            }
          ]
        }) }}

        {{ radios({
          "idPrefix": "gpAppointmentError",
          "name": "gpAppointmentError",
          "fieldset": {
            "legend": {
              "text": "Book a GP appointment error",
              "classes": "nhsuk-label"
            }
          },
          "items": [
            {
              "value": "yes",
              "text": "Yes",
              checked: checked("gpAppointmentError", "yes")
            },
            {
              "value": "no",
              "text": "No",
              checked: checked("gpAppointmentError", "no")
            }
          ]
        }) }}

        <hr>

        <h2 class="nhsuk-heading-m nhsuk-u-margin-bottom-3">Messages</h2>

        {{ radios({
          "idPrefix": "message1read",
          "name": "message1read",
          "fieldset": {
            "legend": {
              "text": "Message 1 read",
              "classes": "nhsuk-label"
            }
          },
          "items": [
            {
              "value": "true",
              "text": "Yes",
              checked: checked("message1read", "true")
            },
            {
              "value": "false",
              "text": "No",
              checked: checked("message1read", "false")
            }
          ]
        }) }}

        {{ radios({
          "idPrefix": "message2read",
          "name": "message2read",
          "fieldset": {
            "legend": {
              "text": "Message 2 read",
              "classes": "nhsuk-label"
            }
          },
          "items": [
            {
              "value": "true",
              "text": "Yes",
              checked: checked("message2read", "true")
            },
            {
              "value": "false",
              "text": "No",
              checked: checked("message2read", "false")
            }
          ]
        }) }}

        {{ input({
          "label": {
          "text": "Number of messages",
          "classes": "nhsuk-label"
          },
          "id": "messages",
          "name": "messages",
          "classes": "nhsuk-input--width-2",
          "value": data['messages']
        }) }}

        {{ radios({
          "idPrefix": "messageSendingError",
          "name": "messageSendingError",
          "fieldset": {
            "legend": {
              "text": "Message sending error",
              "classes": "nhsuk-label"
            }
          },
          "hint": {
            "text": "This shows the 'Cannot send your reply' page when replying to message 2"
          },
          "items": [
            {
              "value": "true",
              "text": "Yes",
              checked: checked("messageSendingError", "true")
            },
            {
              "value": "false",
              "text": "No",
              checked: checked("messageSendingError", "false")
            }
          ]
        }) }}

        <hr>

        <h2 class="nhsuk-heading-m nhsuk-u-margin-bottom-3">Linked profile account</h2>

        {{ input({
          "label": {
          "text": "First name"
          },
          "id": "linkedProfileFirstName",
          "name": "linkedProfileFirstName",
          "classes": "",
          "value": data['linkedProfileFirstName']
        }) }}

        {{ input({
          "label": {
          "text": "Last name"
          },
          "id": "linkedProfileLastName",
          "name": "linkedProfileLastName",
          "classes": "",
          "value": data['linkedProfileLastName']
        }) }}

        {{ input({
          "label": {
          "text": "Age"
          },
          "id": "linkedProfileAge",
          "name": "linkedProfileAge",
          "classes": "nhsuk-input--width-2",
          "value": data['linkedProfileAge']
        }) }}

        <hr>

        {{ input({
          "label": {
          "text": "Version",
          "classes": "nhsuk-label--m nhsuk-u-margin-bottom-3"
          },
          "id": "version",
          "name": "version",
          "classes": "",
          "value": data['version']
        }) }}

        <hr>

        {{ button({
          text: "Save settings",
          classes: "nhsapp-button"
        }) }}

        <p><a href="/clear-data">Reset data settings</a></p>

      </form>

      <div class="nhsuk-inset-text">
        <p>The default data is set in the <a href="https://github.com/nhsuk/nhs-app-redesign-prototype/blob/main/app/data/session-data-defaults.js">/data/session-data-default.js</a> file.</p>
      </div>

    </div>
  </div>
{% endblock %}
